# ADR6 - взаимодействие сервисов WellDriver

## Решение ПРИНЯТО

## Контекст

* Требования к системе WellDiver прописаны в документе [WellDriver](../WellDriver.md)
* Контекстная диаграмма была проработана в [ADR1](ADR1.md)
* Выбор архитектурного подхода был разобран в [ADR2](ADR2.md)
* Компонентная схема системы была принята в [ADR3](ADR3.md)
* По оценке модифицируемости была принята новая схема компонентов по доменным областям в [ADR5](ADR5.md), которая подразумевает универсальный подход к источникам и приемникам данных
* Необходимо принять решение по последовательности прохождения данных, межсервисному взаимодействию и интерфейсам передачи данных 

## Диаграмма последовательности (sequence diagram):

![sequence diagram](ADR6_data/welldriver_sequence_diagram.png)
В процессе предварительного архитектурного анализа было выделено несколько сервисов для системы WellDriver:
* OPC Server - прием данных с датчиков по протоколу OPC.
* OPC Client - предварительная обработка тэгов OPC сервера и привязка к параметрам бурения.
* Validation service - первоначальная обработка и валидация полученных параметров.
* Collector - запись данных в локальную БД и передача для посылки в удаленный расчетный сервис. Здесь должна быть обеспечена транзакционная запись и передача в удаленный сервис
* Database - локальная база данных.
* Transceiver - передача данных в расчетный сервис и прием рассчитанных параметров от него.
* Remote calculation service - удаленный сервис инженерных расчетов.

## Взаимодействие сервисов:
Рассмотрим взаимодействие сервисов по синхронной и асинхронной семантике и возможности преобразования сервисов в микросервисы.
С учетом того, что удаленный сервис инженерных расчетов работает по протоколу REST API общая семантика будет синхронной и общее время обработки будет включать время рассчета, 
которое мы не можем контролировать полностью.
Также нужно иметь в виду, что необходимо обеспечить транзакционную модель при записи в базу данных с одновременной отправкой параметров в удаленный сервис.

![Взаимодействие сервисов](ADR6_data/welldriver_services_interaction.png)
 
* Сервис OPC Server (или несколько серверов) может быть удаленным, а может быть реализован в составе системы WellDriver: получает данные со всех датчиков и отаправляет их в OPC Client, 
также принимает данные от OPC Clientа и направляет их на исполнительные механизмы. Обмен данными осуществляется по протоколу OPC в виде тэгов парамнтров данных.
* Сервис OPC Client может быть реализован в виде микросервиса. Сервис делает маппинг тэгов OPC сервера и параметров бурения. Отправляет принятые данные в виде сообщений во входную очередь локального валидатора. Здесь реализована асинхронная модель обмена сообщениями по pub/sub.
* Сервис Локальный валидатор принимает сообщения из очереди по подписке, производит валидацию параметров данных бурения (проверка на тип, статус, источник данных) и отправляет параметры дальше в брокер сообщений для передачи сервис реализующий транакционную модель (запись в БД и передача в удаленный сервис расчетов). Сервис валидатор также может выполнен в виде микросервиса. Здесь реализована асинхронная модель обмена сообщениями по pub/sub.
* Сервис реализущий транзакционную модель реализован по паттерну Transactional OutBox, где Коллектор осуществляет транзакционную (по БД) запись информации в БД и в таблицу Outbox, а Message Relay транзакционно (по БД) считывает информацию из таблицы Outbox и отправляет данные в очередь удаленного сервиса расчетов. Здесь же реализована функция приема сообщений из удаленного сервиса расчетов и отправка полученных данных в выходную очередь валидатора по pub/sub. выполняет несколько функций:
	* запись информации в БД (PostgreSQL - для транзакций и Redis - кэш данных)
	* отправку информации в очередь удаленного сервиса расчетов.
	* возможна реализация собственного локального сервиса расчетов.Так как здесь мы полностью контролируем код, то нет необходимости пропускать данные через валидатор.
* Сервис OPC Client принимает данные по подписке из Входная очереди ОРС Cient и по протоколу OPC отправляет их далее на исполнительные механизмы в виде уставок. 
* При создании сообщения ему присваиваются атрибуты:
	* Id - идентификатор сообщения (в таблице Outbox Message_Id)
	* Name - имя параметрам
	* Value - значение параметра
	* Type - тип параметра
	* Status - статус сообщения
	* Source - источник данных
	* SourceTime - время сообщения, которое контролируется при реализации realtime передачи данных. 

## Оценка атрибутов качества по заданным критериям

* Доступность - здесь подразумевается то, что сервис должен быть в работе (доступен) в любое время  с вероятностью 99,9% (исходя из специфики работы). Это гарантирутся выбранными архитектурными решениями по бесперебойной и надежной передаче данных. 
* Производительность - время обработки в нормальных условиях (при наличии связи) < 10 секунд (реальное время). Здесь подразумевается, что мы контролируем прямое и обратное направления передачи от сервиса удаленных рассчетов и принятые решения по использованию в межсервисных коммуникациях асинхронного подхода по подписке с помощью высокопроизводительного брокера сообщений RabbitMQ оправдано и укладывается в заданные параметры производительности.
* Надежность - использование в межсервисных коммуникациях надежного брокера сообщений RabbitMQ с возможностью подтверждения передачи гарантирует надежную передачу данных без потерь. Также использование паттерна Transactional OutBox гарантирует сохранение и передачу данных с соблюдением консистентности данных в конечном счете.
* Безопасность - здесь подразумевается технологическая безопасность бурения, которая подразумевает четкое выполнение бурения по рассчетным параметрам в исполнительных механизмах, а это гпрпнтируется  организацией архитектурв системы WellDriver. Актуальность realtime данных контролируется по трем атрибутам - идентификатору сообщения, времени создания сообщения и глубине.
* Расширяемость - приведена реализация допоплнительного локального сервиса расчета, что подтверждает возможность расширения сервисов. Также использование асинхронной семантики по подписке с помощью брокера сообщений позволяет просто подкючить новый сервис добавлением очереди. 
* Масштабируемость - при значительном увеличении источников данных и параметров возможно вертикальное и горизонтальное масштабирование всех компонентов stateless системы.
* Модифицируемость - новые функции добавляются путем введения новых сервисов. Модификация старых сервисов производится путем локального изменения кода.  Все межсервисные взаимодействия зафиксированы в контрактах при изменении которых производится коррекция только смежных сервисов. 

# Решение:
Исходя из характера взаимодействия и передаваемых данных для межсервисного обмена было принято решение использовать брокер сообщений RabbitMQ, который, кроме обеспечения надежности, позволяет реализовать синхронную семантику при взаимодействии с удаленным сервисом. Для гарантии передачи в удаленный сервис использовать паттерн Transactional OutBox для обеспечения eventual консистентности. 
 
# Последствия решения:

* возможность реализации универсальной архитектуры  

# Риски:
* недостаточная пропускная способность брокера сообщений
* возможные задержки при передаче данных реального времени
	

